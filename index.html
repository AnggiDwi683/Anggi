<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RSA QR Tool (PDF & DOCX)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@7.1.0/build/index.min.js"></script>
</head>
<body class="bg-gray-100 p-6 font-sans max-w-4xl mx-auto">

  <h1 class="text-3xl font-bold mb-6 text-center">RSA QR Tool (PDF & DOCX)</h1>

  <!-- File Upload -->
  <div class="mb-4">
    <label class="font-semibold">Unggah File PDF atau DOCX:</label>
    <input type="file" id="file-input" accept=".pdf,.docx" class="block mt-2">
  </div>

  <!-- Ciphertext input -->
  <div class="mb-4">
    <label class="font-semibold">Masukkan atau Scan Ciphertext QR Code:</label>
    <textarea id="ttd-cipher" rows="3" class="w-full border px-2 py-1 rounded" placeholder="Masukkan cipher teks di sini atau scan QR..."></textarea>
  </div>

  <!-- Scan QR or Upload Image -->
  <div class="mb-4">
    <button onclick="startCamera()" class="bg-blue-600 text-white px-4 py-2 rounded mr-2">ðŸ“· Scan QR dengan Kamera</button>
    <input type="file" accept="image/*" onchange="scanQR(event)" class="inline-block ml-2">
  </div>

  <video id="video" class="w-full rounded border mb-4 hidden" autoplay></video>
  <canvas id="qr-canvas" class="hidden"></canvas>

  <button onclick="addQRCodeToFile()" class="bg-green-700 text-white px-6 py-3 rounded w-full text-lg font-semibold">ðŸ–Š Tambah QR Code ke File & Unduh</button>

<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("qr-canvas");
  const ctx = canvas.getContext("2d");
  let videoStream;
  let scanning = false;

  async function scanQR(event) {
    const file = event.target.files[0];
    if (!file) return alert("Pilih gambar QR code!");
    const reader = new FileReader();
    reader.onload = function() {
      const img = new Image();
      img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if (code) {
          document.getElementById("ttd-cipher").value = code.data;
          alert("QR code berhasil dipindai!");
        } else {
          alert("QR code tidak terbaca.");
        }
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(file);
  }

  function startCamera() {
    if (scanning) {
      stopCamera();
      return;
    }
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        videoStream = stream;
        video.srcObject = stream;
        video.classList.remove("hidden");
        scanning = true;
        video.play();
        scanLoop();
      }).catch(e => alert("Gagal akses kamera: " + e));
  }
  function stopCamera() {
    if (videoStream) {
      videoStream.getTracks().forEach(track => track.stop());
      video.classList.add("hidden");
      scanning = false;
    }
  }
  function scanLoop() {
    if (!scanning) return;
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);
      if (code) {
        scanning = false;
        stopCamera();
        document.getElementById("ttd-cipher").value = code.data;
        alert("QR code berhasil dipindai!");
        return;
      }
    }
    requestAnimationFrame(scanLoop);
  }

  async function addQRCodeToFile() {
    const fileInput = document.getElementById("file-input");
    const cipher = document.getElementById("ttd-cipher").value.trim();
    if (!fileInput.files[0]) return alert("Unggah file PDF atau DOCX terlebih dahulu!");
    if (!cipher) return alert("Masukkan atau scan cipher teks QR terlebih dahulu!");

    const file = fileInput.files[0];
    const ext = file.name.split('.').pop().toLowerCase();

    // Generate QR canvas and convert to base64 png
    const qrCanvas = document.createElement("canvas");
    await QRCode.toCanvas(qrCanvas, cipher);
    const qrDataUrl = qrCanvas.toDataURL("image/png");

    if (ext === "pdf") {
      // Process PDF
      const existingPdfBytes = await file.arrayBuffer();
      const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
      const pages = pdfDoc.getPages();
      const lastPage = pages[pages.length - 1];
      const pngImage = await pdfDoc.embedPng(qrDataUrl);
      const { width, height } = lastPage.getSize();
      const pngDims = pngImage.scale(0.25); // kecil

      lastPage.drawImage(pngImage, {
        x: width - pngDims.width - 50,
        y: 100,
        width: pngDims.width,
        height: pngDims.height,
      });

      const pdfBytes = await pdfDoc.save();
      const blob = new Blob([pdfBytes], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      downloadFile(url, file.name.replace(/\.pdf$/i, "_signed.pdf"));
      URL.revokeObjectURL(url);

    } else if (ext === "docx") {
      // Process DOCX
      // Use docx library: embed image in footer right bottom (page 1)
      const arrayBuffer = await file.arrayBuffer();

      const zip = await window.docx.Packer.unzip(arrayBuffer);
      const doc = await window.docx.Document.load(zip);

      // Create image from base64
      const image = window.docx.Media.addImage(doc, qrDataUrl);

      // Create footer with image aligned right
      const footer = new window.docx.Footer({
        children: [new window.docx.Paragraph({
          children: [image],
          alignment: window.docx.AlignmentType.RIGHT,
          spacing: { before: 100 }
        })],
      });

      // Replace existing footers or add new to first section
      const sections = doc.getSections();
      if (sections.length > 0) {
        sections[0].footers = { default: footer };
      } else {
        doc.addSection({ footers: { default: footer } });
      }

      const packed = await window.docx.Packer.toBlob(doc);
      downloadBlob(packed, file.name.replace(/\.docx$/i, "_signed.docx"));
    } else {
      alert("Format file tidak didukung. Gunakan PDF atau DOCX.");
    }
  }

  function downloadFile(url, filename) {
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
  }
  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    downloadFile(url, filename);
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }
</script>

</body>
</html>
