<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RSA Encrypt & Decrypt with QR</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.9/minified/html5-qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea, input { width: 100%; margin-bottom: 10px; padding: 8px; }
    button { padding: 10px 15px; margin-bottom: 10px; }
    #qrcode, #reader { margin-top: 20px; }
    .section { border: 1px solid #ccc; padding: 15px; margin-bottom: 30px; }
    h2 { margin-top: 0; }
  </style>
</head>
<body>

  <div class="section">
    <h2>üîê RSA Enkripsi & QR Code</h2>
    <label>Plaintext (ID Dokumen):</label>
    <textarea id="plaintext">SERTIFIKAT/012/24052025/IGUSTIAYUSRI_BIDANGPENGMAS</textarea>

    <label>p (prima):</label>
    <input type="number" id="p" value="61">

    <label>q (prima):</label>
    <input type="number" id="q" value="53">

    <label>e:</label>
    <input type="number" id="e" value="17">

    <button onclick="encryptRSA()">üîí Enkripsi dan Buat QR Code</button>

    <label>Hasil Ciphertext:</label>
    <textarea id="ciphertext" readonly></textarea>

    <div id="qrcode"></div>
    <button onclick="downloadQR()">üíæ Simpan QR Code</button>
  </div>

  <div class="section">
    <h2>üîì Dekripsi QR Code atau Ciphertext</h2>
    
    <label>1Ô∏è‚É£ Masukkan Ciphertext (dari QR atau manual):</label>
    <textarea id="scannedCiphertext" placeholder="Paste ciphertext atau scan QR Code..."></textarea>

    <div id="reader" style="width: 300px;"></div>
    <button onclick="startScanner()">üì∑ Scan QR Code</button>
    <button onclick="stopScanner()">‚úã Stop Scan</button>

    <label>2Ô∏è‚É£ Masukkan kunci privat:</label>
    <label>p:</label><input type="number" id="dp">
    <label>q:</label><input type="number" id="dq">
    <label>e:</label><input type="number" id="de">

    <button onclick="decryptRSA()">üîì Dekripsi</button>

    <label>Hasil Plaintext:</label>
    <textarea id="decryptedText" readonly></textarea>
  </div>

  <script>
    function modInverse(e, phi) {
      let [a, b] = [e, phi], [x, y] = [0, 1];
      while (a !== 0) {
        [q, r] = [Math.floor(b / a), b % a];
        [b, a] = [a, r];
        [x, y] = [y - q * x, x];
      }
      return (y + phi) % phi;
    }

    function modPow(base, exp, mod) {
      let result = 1n;
      base = BigInt(base);
      exp = BigInt(exp);
      mod = BigInt(mod);
      while (exp > 0) {
        if (exp % 2n === 1n) result = (result * base) % mod;
        base = (base * base) % mod;
        exp = exp / 2n;
      }
      return result;
    }

    function gcd(a, b) {
      while (b !== 0) [a, b] = [b, a % b];
      return a;
    }

    function encryptRSA() {
      const plaintext = document.getElementById("plaintext").value;
      const p = parseInt(document.getElementById("p").value);
      const q = parseInt(document.getElementById("q").value);
      const e = parseInt(document.getElementById("e").value);
      const n = p * q;
      const phi = (p - 1) * (q - 1);

      if (gcd(e, phi) !== 1) return alert("e harus coprime dengan phi(n)");

      const encrypted = [];
      for (let i = 0; i < plaintext.length; i++) {
        const m = plaintext.charCodeAt(i);
        const c = modPow(m, e, n);
        encrypted.push(c.toString());
      }

      const ciphertext = encrypted.join(" ");
      document.getElementById("ciphertext").value = ciphertext;

      document.getElementById("qrcode").innerHTML = "";
      QRCode.toCanvas(ciphertext, { width: 250 }, function (err, canvas) {
        if (err) console.error(err);
        canvas.id = "qrCanvas";
        document.getElementById("qrcode").appendChild(canvas);
      });
    }

    function downloadQR() {
      const canvas = document.getElementById("qrCanvas");
      if (!canvas) return alert("QR Code belum dibuat.");
      const link = document.createElement("a");
      link.download = "qrcode.png";
      link.href = canvas.toDataURL();
      link.click();
    }

    function decryptRSA() {
      const ciphertext = document.getElementById("scannedCiphertext").value.trim();
      const p = parseInt(document.getElementById("dp").value);
      const q = parseInt(document.getElementById("dq").value);
      const e = parseInt(document.getElementById("de").value);
      const n = p * q;
      const phi = (p - 1) * (q - 1);
      const d = modInverse(e, phi);

      const parts = ciphertext.split(" ");
      let plaintext = "";
      for (let i = 0; i < parts.length; i++) {
        const c = BigInt(parts[i]);
        const m = modPow(c, d, n);
        plaintext += String.fromCharCode(Number(m));
      }

      document.getElementById("decryptedText").value = plaintext;
    }

    // QR SCANNER
    let scanner;
    function startScanner() {
      if (!scanner) {
        scanner = new Html5Qrcode("reader");
        scanner.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decodedText, decodedResult) => {
            document.getElementById("scannedCiphertext").value = decodedText;
            stopScanner();
          },
          (err) => { /* ignore scan errors */ }
        );
      }
    }

    function stopScanner() {
      if (scanner) {
        scanner.stop().then(() => {
          scanner.clear();
          scanner = null;
        });
      }
    }
  </script>
</body>
</html>
