<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RSA Encrypt + QR</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea, input { width: 100%; margin-bottom: 10px; padding: 8px; }
    button { padding: 10px 15px; }
    #qrcode { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>RSA Encryption + QR Code</h2>

  <label>ID Dokumen (Plaintext):</label>
  <textarea id="plaintext">SERTIFIKAT/012/24052025/IGUSTIAYUSRI_BIDANGPENGMAS</textarea>

  <label>Bilangan Prima p:</label>
  <input type="number" id="p" value="61">

  <label>Bilangan Prima q:</label>
  <input type="number" id="q" value="53">

  <label>Eksponen e:</label>
  <input type="number" id="e" value="17">

  <button onclick="encryptRSA()">ðŸ”’ Enkripsi dan Buat QR Code</button>

  <label>Hasil Ciphertext:</label>
  <textarea id="ciphertext" readonly></textarea>

  <div id="qrcode"></div>
  <button onclick="downloadQR()">ðŸ’¾ Simpan QR Code</button>

  <script>
    function modInverse(e, phi) {
      let [a, b] = [e, phi], [x, y] = [0, 1];
      while (a !== 0) {
        [q, r] = [Math.floor(b / a), b % a];
        [b, a] = [a, r];
        [x, y] = [y - q * x, x];
      }
      return (y + phi) % phi;
    }

    function modPow(base, exp, mod) {
      let result = 1n;
      base = BigInt(base);
      exp = BigInt(exp);
      mod = BigInt(mod);
      while (exp > 0) {
        if (exp % 2n === 1n) result = (result * base) % mod;
        base = (base * base) % mod;
        exp = exp / 2n;
      }
      return result;
    }

    function encryptRSA() {
      const plaintext = document.getElementById("plaintext").value;
      const p = parseInt(document.getElementById("p").value);
      const q = parseInt(document.getElementById("q").value);
      const e = parseInt(document.getElementById("e").value);

      const n = p * q;
      const phi = (p - 1) * (q - 1);

      // Validasi kunci
      if (gcd(e, phi) !== 1) {
        alert("e harus coprime dengan phi(n).");
        return;
      }

      // Enkripsi karakter demi karakter
      const encrypted = [];
      for (let i = 0; i < plaintext.length; i++) {
        const m = plaintext.charCodeAt(i);
        const c = modPow(m, e, n);
        encrypted.push(c.toString());
      }

      const ciphertext = encrypted.join(" ");
      document.getElementById("ciphertext").value = ciphertext;

      // Buat QR Code
      document.getElementById("qrcode").innerHTML = "";
      QRCode.toCanvas(ciphertext, { width: 250 }, function (err, canvas) {
        if (err) console.error(err);
        canvas.id = "qrCanvas";
        document.getElementById("qrcode").appendChild(canvas);
      });
    }

    function gcd(a, b) {
      while (b !== 0) {
        [a, b] = [b, a % b];
      }
      return a;
    }

    function downloadQR() {
      const canvas = document.getElementById("qrCanvas");
      if (!canvas) {
        alert("QR Code belum dibuat.");
        return;
      }
      const link = document.createElement("a");
      link.download = "qrcode.png";
      link.href = canvas.toDataURL();
      link.click();
    }
  </script>
</body>
</html>
